stages:
  - deploy
  - notification

cache:
  paths:
    - backend/node_modules/

deploy:
  stage: deploy
  only:
    - production # —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π –≤–µ—Ç–∫–∏
  tags:
    - deploy
  script:
    - sh deploy/.ci-notify.sh "–°–æ–±–∏—Ä–∞—é –ø—Ä–æ–µ–∫—Ç ‚ò∫Ô∏è" || true
    - docker-compose build --pull
    - sh deploy/.ci-notify.sh "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã ü•≥" || true
    - docker-compose down --remove-orphans
    - docker-compose up -d --build
    - sh deploy/.ci-notify.sh "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã! ü•∞" || true
    - sudo docker image prune -f
  when: always
  except:
    - master # –∏—Å–∫–ª—é—á–∏—Ç—å –≤–µ—Ç–∫–∏

notify_error:
  stage: notification
  only:
    - production
  tags:
    - notification
  script:
    - sh deploy/.ci-notify.sh "–£–ø—Å, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫... üòî"
  when: on_failure